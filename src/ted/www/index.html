<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>TLV Editor</title>
<script src="js/jquery-2.2.1.js"></script>
<link rel="stylesheet" href="css/bootstrap.css">
<link rel="stylesheet" href="css/bootstrap-theme.css">
<script src="js/bootstrap.js"></script>
<script src="js/tree.jquery.js"></script>
<link rel="stylesheet" href="css/jqtree.css">
</head>
<body>
</body>

<!-- Add/Edit TLV Node Dialog -->
<div id="edit-tlv-node" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Edit TLV Node</h4>
      </div>
      <div class="modal-body">
        <form class="form-horizontal" role="form">
          <div class="form-group">
            <label class="control-label col-md-1" for="input-tag">Tag:</label>
            <div class="col-md-11">
              <div class="input-group">
                <input type="text" class="form-control" id="input-tag">
                <span class="input-group-addon">Account Type</span>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="control-label col-md-1" for="input-value">Value:</label>
            <div class="col-md-11">
              <div class="input-group">
              <input type="text" class="form-control" id="input-value">
              <div class="input-group-btn">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">b <span class="caret"></span></button>
                <ul class="dropdown-menu dropdown-menu-right">
                  <li><a href="#">an</a></li>
                  <li><a href="#">ans</a></li>
                  <li><a href="#">b</a></li>
                  <li><a href="#">cn</a></li>
                  <li><a href="#">n</a></li>
                </ul>
              </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">OK</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row col-md-12">
    <h1>TED - TLV Editor</h1>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Document</h3>
        </div>

        <div class="panel-body">
          <div id="tlv-tree">
          </div>
        </div>

        <div class="panel-footer">
            <div class="btn-toolbar" role="toolbar">
              <div class="btn-group pull-right" role="toolbar">
                <button type="button" class="btn btn-default" data-toggle="modal" data-target="#edit-tlv-node"><span class="glyphicon glyphicon-plus"></span></button>
                <button type="button" class="btn btn-default" data-toggle="modal" data-target="#edit-tlv-node"><span class="glyphicon glyphicon-remove"></span></button>
                <button type="button" class="btn btn-default" data-toggle="modal" data-target="#edit-tlv-node"><span class="glyphicon glyphicon-pencil"></span></button>
              </div>
              <div class="btn-group pull-right" role="group">
                <button type="button" class="btn btn-default"><span class="glyphicon glyphicon-floppy-save"></span></button>
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-eye-open"></span> Tree <span class="caret"></span></button>
                <ul class="dropdown-menu dropdown-menu-right">
                  <li><a href="#">Raw</a></li>
                  <li><a href="#">Tree</a></li>
                  <li><a href="#">Interpreted</a></li>
                </ul>
              </div>
	    </div>
        </div>
      </div>

    </div>

    <div class="col-md-4">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Node Details</h3>
        </div>
        <div class="panel-body">
          <h3>Account Type</h3>
          <p>Indicates the type of account selected on the terminal, coded as specified in Annex G</p>
          <table class="table">
            <thead>
              <tr>
                <th>Tag</th>
                <th>Source</th>
                <th>Format</th>
                <th>Template</th>
                <th>Length</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>5F57</td>
                <td>Terminal</td>
                <td>n 2</td>
                <td>-</td>
                <td>1</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>


  </div>
</div>

<script>

function toHex(b) {
	var hex= [ '0', '1', '2', '3', '4', '5', '6', '7',
		   '8', '9', 'A', 'B', 'C', 'D', 'E', 'F' ];

	return hex[Math.floor(b / 16)] + hex[b % 16];
}

function tlvParseValueLen(tlv) {
	var LONG_FORM = 0x80;
	var valueLen = 0;

	if ((tlv[0] & LONG_FORM) !== LONG_FORM)
		return { len: 1, value: tlv[0] };

	for (var i = 0; i < tlv[0] % 128; i++) {
		valueLen *= 256;
		valueLen += tlv[i + 1];
	}

	return { len: (tlv[0] % 128) + 1, value: valueLen };
}

function tlvParseSubtree(tlv) {
	var TAG_NUMBER = 0x1f;
	var TAG_CONSTRUCTED = 0x20;
	var TAG_CONTINUE = 0x80;
	var tag = {};
	var value = {};
	var valueLen = 0;
	var result = {};

	tag.value = toHex(tlv[0]);
	tag.len = 1;

	if ((tlv[0] & TAG_NUMBER) === TAG_NUMBER)
		do
			tag.value += toHex(tlv[tag.len++]);
		while ((tlv[tag.len] & TAG_CONTINUE) === TAG_CONTINUE)

	valueLen = tlvParseValueLen(tlv.slice(tag.len));
	value.len = valueLen.value;

	if (value.len > 0) {
		var valueField = tlv.slice(tag.len + valueLen.len,
					   tag.len + valueLen.len + value.len);

		if ((tlv[0] & TAG_CONSTRUCTED) === TAG_CONSTRUCTED)
			value.value = tlvParse(valueField);
		else
			value.value = valueField.reduce(
				function(prev, cur, idx, arr) {
					return prev + toHex(cur);
				}, "");
	}

	return { len: tag.len + valueLen.len + value.len,
		 value: { tag: tag.value, value: value.value } };
}

function tlvParse(tlv) {
	var result = [];
	var offset = 0;

	while (offset < tlv.length) {
		var subtree = tlvParseSubtree(tlv.slice(offset));

		result.push(subtree.value);
		offset += subtree.len;
	}

	return result;
}

function tlvParseHex(hex) {
	var tlv = [];

	for (var i = 0; i < hex.length / 2; i++)
		tlv[i] = parseInt(hex.substr(i * 2, 2), 16);

	return tlvParse(tlv);
}

function tlvToJqTree(tlv) {
	var data = [];

	tlv.forEach(
		function(cur, idx, arr) {
			var node = {};

			node.label = cur.tag;
			node.tag = cur.tag;

			if ($.isArray(cur.value))
				node.children = tlvToJqTree(cur.value);

			if (typeof(cur.value) === 'string') {
				node.value = cur.value;
				node.label += " " + cur.value;
			}

			this.push(node);
		},
		data
	);

	return data;
}

var connection = new WebSocket('ws://localhost:7681', ['jsonrpc']);
connection.onopen = function() {
	connection.send('{"jsonrpc": "2.0", "method": "get_doc", "id": 1}');
};
connection.onerror = function(error) {
	console.log('Error: ' + error);
};
connection.onmessage = function(event) {
	var tlv = $('#tlv-tree');

	tlv.tree({
		data: tlvToJqTree(tlvParseHex($.parseJSON(event.data).result)),
		dragAndDrop : true,
		onCreateLi : function(node, $li) {
			var title = $li.find('.jqtree-title');
		},
		onCanMoveTo : function(moved, target, position) {
			if (position == 'inside') {
				var TAG_CONSTRUCTED = 0x20;
				var b0 = parseInt(target.name.slice(0, 2), 16);
				return ((b0 & TAG_CONSTRUCTED) == TAG_CONSTRUCTED);
			} else {
				return true;
			}
		}
	});

	tlv.bind('tree.select', function(event) {
		if (event.node) {
			$('#input-tag').prop('disabled', false);
			$('#input-tag').val(event.node.tag);
			if (event.node.value) {
				$('#input-value').prop('disabled', false);
				$('#input-value').val(event.node.value);
			} else {
				$('#input-value').val('');
				$('#input-value').prop('disabled', true);
			}
		} else {
			$('#input-tag').val('');
			$('#input-tag').prop('disabled', true);
			$('#input-value').val('');
			$('#input-value').prop('disabled', true);
		}
	});
};
</script>

</html>
