<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>TLV Editor</title>
<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqtree/1.3.0/tree.jquery.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqtree/1.3.0/jqtree.css">
</head>
<body>
</body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Project name</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">

      <div class="starter-template">
        <h1>Bootstrap starter template</h1>
        <p class="lead">Use this document as a way to quickly start any new project.<br> All you get is this text and a mostly barebones HTML document.</p>
      </div>

    </div><!-- /.container -->

    <div class="container">
            <div class="input-group">
                <span class="input-group-addon" id="basic-addon1">Tag</span>
                <input type="text" class="form-control" id="input-tag" disabled>
            </div>

            <div class="input-group">
                <span class="input-group-addon" id="basic-addon1">Value</span>
                <input type="text" class="form-control" id="input-value" disabled>
                    <div class="input-group-btn">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Format: b <span class="caret"></span></button>
                        <ul class="dropdown-menu dropdown-menu-right">
                            <li><a href="#">an</a></li>
                            <li><a href="#">ans</a></li>
                            <li><a href="#">b</a></li>
                            <li><a href="#">cn</a></li>
                            <li><a href="#">n</a></li>
                        </ul>
                    </div>
            </div>

        <div id="tlv-tree">
        </div>
    </div>

<script>

function toHex(b) {
	var hex= [ '0', '1', '2', '3', '4', '5', '6', '7',
		   '8', '9', 'A', 'B', 'C', 'D', 'E', 'F' ];

	return hex[Math.floor(b / 16)] + hex[b % 16];
}

function tlvParseValueLen(tlv) {
	var LONG_FORM = 0x80;
	var valueLen = 0;

	if ((tlv[0] & LONG_FORM) !== LONG_FORM)
		return { len: 1, value: tlv[0] };

	for (var i = 0; i < tlv[0] % 128; i++) {
		valueLen *= 256;
		valueLen += tlv[i + 1];
	}

	return { len: (tlv[0] % 128) + 1, value: valueLen };
}

function tlvParseSubtree(tlv) {
	var TAG_NUMBER = 0x1f;
	var TAG_CONSTRUCTED = 0x20;
	var TAG_CONTINUE = 0x80;
	var tag = {};
	var value = {};
	var valueLen = 0;
	var result = {};

	tag.value = toHex(tlv[0]);
	tag.len = 1;

	if ((tlv[0] & TAG_NUMBER) === TAG_NUMBER)
		do
			tag.value += toHex(tlv[tag.len++]);
		while ((tlv[tag.len] & TAG_CONTINUE) === TAG_CONTINUE)

	valueLen = tlvParseValueLen(tlv.slice(tag.len));
	value.len = valueLen.value;

	if (value.len > 0) {
		var valueField = tlv.slice(tag.len + valueLen.len,
					   tag.len + valueLen.len + value.len);

		if ((tlv[0] & TAG_CONSTRUCTED) === TAG_CONSTRUCTED)
			value.value = tlvParse(valueField);
		else
			value.value = valueField.reduce(
				function(prev, cur, idx, arr) {
					return prev + toHex(cur);
				}, "");
	}

	return { len: tag.len + valueLen.len + value.len,
		 value: { tag: tag.value, value: value.value } };
}

function tlvParse(tlv) {
	var result = [];
	var offset = 0;

	while (offset < tlv.length) {
		var subtree = tlvParseSubtree(tlv.slice(offset));

		result.push(subtree.value);
		offset += subtree.len;
	}

	return result;
}

function tlvParseHex(hex) {
	var tlv = [];

	for (var i = 0; i < hex.length / 2; i++)
		tlv[i] = parseInt(hex.substr(i * 2, 2), 16);

	return tlvParse(tlv);
}

function tlvToJqTree(tlv) {
	var data = [];

	tlv.forEach(
		function(cur, idx, arr) {
			var node = {};

			node.label = cur.tag;
			node.tag = cur.tag;

			if ($.isArray(cur.value))
				node.children = tlvToJqTree(cur.value);

			if (typeof(cur.value) === 'string')
				node.value = cur.value;

			this.push(node);
		},
		data
	);

	return data;
}

var connection = new WebSocket('ws://localhost:7681', ['jsonrpc']);
connection.onopen = function() {
	connection.send('{"jsonrpc": "2.0", "method": "get_doc", "id": 1}');
};
connection.onerror = function(error) {
	console.log('Error: ' + error);
};
connection.onmessage = function(event) {
	var tlv = $('#tlv-tree');

	tlv.tree({
		data: tlvToJqTree(tlvParseHex($.parseJSON(event.data).result)),
		dragAndDrop : true,
		onCreateLi : function(node, $li) {
			var title = $li.find('.jqtree-title');
			if ('value' in node)
				title.after('<span class="value"> ' + node.value + '</span>');
		},
		onCanMoveTo : function(moved, target, position) {
			if (position == 'inside') {
				var TAG_CONSTRUCTED = 0x20;
				var b0 = parseInt(target.name.slice(0, 2), 16);
				return ((b0 & TAG_CONSTRUCTED) == TAG_CONSTRUCTED);
			} else {
				return true;
			}
		}
	});

	tlv.bind('tree.select', function(event) {
		if (event.node) {
			$('#input-tag').prop('disabled', false);
			$('#input-tag').val(event.node.name);
			if (event.node.value) {
				$('#input-value').prop('disabled', false);
				$('#input-value').val(event.node.value);
			} else {
				$('#input-value').val('');
				$('#input-value').prop('disabled', true);
			}
		} else {
			$('#input-tag').val('');
			$('#input-tag').prop('disabled', true);
			$('#input-value').val('');
			$('#input-value').prop('disabled', true);
		}
	});
};
</script>

</html>
